<!DOCTYPE html>
<html>
<head>
    <title>GPS Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            z-index: 1000;
        }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button id="getHistory">Get History</button>
        <button id="stopHistory">Stop History</button>
        <button id="exportJpg">Export to JPG</button>
    </div>
     <div class="info">
        <h2>GPS Info</h2>
        <p>Latitude: <span id="latitude">-</span></p>
        <p>Longitude: <span id="longitude">-</span></p>
        <p>Altitude: <span id="altitude">-</span> meters</p>
        <p>Speed: <span id="speed">-</span> m/s</p>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.7/dist/html2canvas.min.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const socket = io();

        let marker;
        let polyline = L.polyline([], {color: 'blue'}).addTo(map);

        socket.on('gpsUpdate', (coords) => {
            const { latitude, longitude } = coords;

            if (marker) {
                marker.setLatLng([latitude, longitude]);
            } else {
                marker = L.marker([latitude, longitude]).addTo(map);
            }

            polyline.addLatLng([latitude, longitude]);
            map.setView([latitude, longitude], 13);

             // Update info
            document.getElementById('latitude').textContent = latitude.toFixed(6);
            document.getElementById('longitude').textContent = longitude.toFixed(6);
            document.getElementById('altitude').textContent = altitude.toFixed(2);
            document.getElementById('speed').textContent = speed.toFixed(2);
        });

        document.getElementById('getHistory').addEventListener('click', () => {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    polyline.setLatLngs(data.map(entry => [entry.latitude, entry.longitude]));
                    if (data.length > 0) {
                        map.setView([data[0].latitude, data[0].longitude], 13);
                    }
                })
                .catch(error => console.error('Error fetching history:', error));
        });

        document.getElementById('stopHistory').addEventListener('click', () => {
            polyline.setLatLngs([]);
        });

        function calculateSpeed(coords1, coords2, time1, time2) {
            const distance = getDistanceFromLatLonInM(coords1.latitude, coords1.longitude, coords2.latitude, coords2.longitude);
            const timeDiff = (time2 - time1) / 1000; // time difference in seconds
            return distance / timeDiff; // speed in meters per second
        }

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius bumi dalam meter
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lat2 - lon2);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Jarak dalam meter
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Fungsi untuk mengekspor peta ke JPG
        document.getElementById('exportJpg').addEventListener('click', () => {
            html2canvas(document.getElementById('map')).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg');
                link.download = 'map.jpg';
                link.click();
            });
        });
    </script>
</body>
</html>
